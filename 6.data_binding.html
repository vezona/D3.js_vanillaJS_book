<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>資料綁定</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./extension/prism.css" />
    <link rel="stylesheet" href="./css/utils.css" />
  </head>
  <body>
    <nav class="bg-orange navbar">
      <div class="container-fluid">
        <a
          class="text-decoration-none fw-bold navbar-brand"
          href="./index.html"
        >
          <span class="nav-title"> D3.js 圖表繪製教學</span>
        </a>
      </div>
    </nav>

    <div class="container p-4">
      <div class="mt-3">
        <h3 class="my-4 fw-bold">綁定 DOM 元素跟資料的方法</h3>
        <ul class="mb-5">
          <li>selection.data( [data[, key]] )</li>
          <li>selection.datum( )</li>
        </ul>

        <h5><mark>selection.data( [data[, key]] )</mark></h5>
        <h6 class="mt-4 fw-bold">1. 綁定單個元素跟數值</h6>
        <div class="mt-4 ps-4">
          <p class="bindData"></p>
        </div>

        <p class="my-4 mb-1">程式碼</p>
        <pre class="border">
          <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
            // html
            &lt;p class=&quot;bindData&quot;&gt;&lt;/p&gt;
          </code>
        </pre>
        <pre>
          <code class="language-js line-numbers remove-initial-line-feed">
              //JS
              const bindData = d3.select('.bindData')
                                  .data(['綁定資料'])
                                  .text(d => d);
              
              // 印出綁定資料的 selection 來看看
              console.log('bindData', bindData)
              // 印出綁定的 data 來看看
              console.log(bindData['_groups'][0][0]['__data__'])
          </code>
        </pre>
        <div class="mt-3 p-3">
          <img class="img-fluid" src="./img/bind-data-selection.jpg" alt="" />
        </div>

        <h6 class="mt-4 fw-bold">2.綁定多個元素跟數值</h6>
        <div class="mt-4 ps-4">
          <p class="bindMultiData"></p>
          <p class="bindMultiData"></p>
          <p class="bindMultiData"></p>
          <p class="bindMultiData"></p>
        </div>

        <p class="my-4 mb-1">程式碼</p>
        <pre class="border">
          <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
            // html
            &lt;p class=&quot;bindMultiData&quot;&gt;&lt;/p&gt;
            &lt;p class=&quot;bindMultiData&quot;&gt;&lt;/p&gt;
            &lt;p class=&quot;bindMultiData&quot;&gt;&lt;/p&gt;
            &lt;p class=&quot;bindMultiData&quot;&gt;&lt;/p&gt;
          </code>
        </pre>
        <pre>
          <code class="language-js line-numbers remove-initial-line-feed">
              //JS
              const multiData = ['綁', '定', '資', '料']
              const bindMultiData = d3.selectAll('.bindMultiData')
                                          .data(multiData)
                                          .text(d => d);
                      
              // 印出綁定資料的 selection 來看看
              console.log('bindMultiData', bindMultiData)
          </code>
        </pre>
        <div class="mt-3 p-3">
          <img class="img-fluid" src="./img/bind-multi-data.jpg" alt="" />
        </div>

        <h6 class="mt-4 fw-bold">3.綁定的元素與 data 數量不匹配</h6>
        <div class="mt-4 ps-4">
          <p class="bindUnmatchData"></p>
          <p class="bindUnmatchData"></p>
        </div>

        <p class="my-4 mb-1">程式碼</p>
        <pre class="border">
          <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
            // html
            &lt;p class=&quot;bindUnmatchData&quot;&gt;&lt;/p&gt;
            &lt;p class=&quot;bindMultiData&quot;&gt;&lt;/p&gt;
          </code>
        </pre>
        <pre>
          <code class="language-js line-numbers remove-initial-line-feed">
              //JS
              const UnmatchData = ['綁', '定', '資', '料']
              const bindUnmatchData = d3.selectAll('.bindUnmatchData')
                                          .data(UnmatchData)
                                          .text(d => d);
                      
              // 印出綁定資料的 selection 來看看
              console.log('bindUnmatchData', bindUnmatchData)
          </code>
        </pre>
        <div class="mt-3 p-3">
          <img class="img-fluid" src="./img/bind-unmatch-data.jpg" alt="" />
        </div>

        <hr />
        <h5 class="mt-4"><mark>selection.datum()</mark></h5>
        <div class="mt-4 ps-4">
          <p class="datum"></p>
        </div>

        <p class="my-4 mb-1 fs-5">程式碼</p>
        <pre class="border">
          <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
            // html
            &lt;p class=&quot;datum&quot;&gt;&lt;/p&gt;
          </code>
        </pre>
        <pre>
          <code class="language-js line-numbers remove-initial-line-feed">
            //JS
            const datumObj = [{name:'jin'}, {name:'JIN'}]
            const bindDatum = d3.select('.datum')
                                .datum(datumObj)
            console.log('bindDatum',bindDatum)
          </code>
        </pre>
        <div class="mt-3 p-3">
          <img class="img-fluid" src="./img/bind-datum.jpg" alt="" />
        </div>
      </div>

      <div class="mt-3">
        <h3 class="my-4 fw-bold">增減資料數量與DOM元素不匹配的方法</h3>
        <ul>
          <li>
            <span class="text-danger fw-bold">update</span> :
            如果資料跟DOM元素能夠綁定，該筆輸入的資料會被歸納為 update 資料。
          </li>
          <li>
            <span class="text-danger fw-bold">enter</span> :
            如果資料沒有DOM元素能綁定，該筆輸入的資料會被歸納為 enter 資料。
          </li>
          <li>
            <span class="text-danger fw-bold">exit</span> :
            如果沒有資料能跟被DOM元素綁定，剩下的元素就會被歸納為 exit 資料。
          </li>
        </ul>
        <div class="mb-2 p-3 w-50">
          <img class="img-fluid" src="./img/enter-update-exit.jpg" alt="" />
        </div>

        <h5>三種API</h5>
        <ul>
          <li>selection.enter( )</li>
          <li>selection.exit( )</li>
          <li>selection.join( )</li>
        </ul>

        <!-- selection.enter -->
        <div>
          <h5><mark>selection.enter()</mark></h5>
          <div class="mt-4 enterData ps-4">
            <p></p>
            <p></p>
          </div>

          <p class="my-4 mb-1 fs-5">程式碼</p>
          <pre class="border">
            <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
              // html
              &lt;div class=&quot;enterDataWrap&quot;&gt;
                &lt;p class=&quot;enterData&quot;&gt;&lt;/p&gt;
                &lt;p class=&quot;enterData&quot;&gt;&lt;/p&gt;
              &lt;/div&gt;
            </code>
          </pre>
          <pre>
            <code class="language-js line-numbers remove-initial-line-feed">
                //JS
                const enterData = ["資", "料", "比", "較", "多"];
                const enterDom = d3.select(".enterData")
                                .selectAll('p')
                                .data(enterData)
                                  .text(d=>d)
                                  
                enterDom.enter()
                        .append('p')
                        .text(d=>d)
                        .classed('fw-bold',true)
                        .classed('text-danger',true)
            </code>
          </pre>
        </div>
        <hr />

        <!-- selection.exit -->
        <div>
          <h5><mark>selection.exit()</mark></h5>
          <div class="mt-4 exitData ps-4">
            <p></p>
            <p></p>
            <p></p>
            <p></p>
            <p></p>
            <p></p>
          </div>

          <p class="my-4 mb-1 fs-5">程式碼</p>
          <pre class="border">
            <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
              // html
              &lt;div class=&quot;exitData&quot;&gt;
                &lt;p&gt;&lt;/p&gt;
                &lt;p&gt;&lt;/p&gt;
                &lt;p&gt;&lt;/p&gt;
                &lt;p&gt;&lt;/p&gt;
                &lt;p&gt;&lt;/p&gt;
                &lt;p&gt;&lt;/p&gt;
              &lt;/div&gt;
            </code>
          </pre>
          <pre>
            <code class="language-js line-numbers remove-initial-line-feed">
              //JS
              const exitData = ["資", "料","少"];
              const exitDom = d3.select(".exitData")
                                .selectAll('p')
                                .data(exitData)
                                .text(d=>d)

              exitDom.exit().remove()
            </code>
          </pre>
        </div>
        <hr />

        <!-- selection.join -->
        <div class="mt-3">
          <h5><mark>selection.join()</mark></h5>
          <div class="mt-4 joinData ps-4"></div>

          <p class="my-4 mb-1 fs-5">程式碼</p>
          <pre class="border">
            <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
              // html
              &lt;div class=&quot;joinData&quot;&gt;&lt;/div&gt;
            </code>
          </pre>
          <pre>
            <code class="language-js line-numbers remove-initial-line-feed">
              //JS
              const joinData = ['j', 'o', 'i', 'n']
              d3.select('.joinData')
                .selectAll('p')
                .data(joinData)
                .join() // 把 update 跟 enter 一起處理
                .append('p')
                .attr('class','text-danger')
                .text(d => d);
            </code>
          </pre>
        </div>

        <!-- selection.merge -->
        <div class="my-4">
          <h5><mark>selection.merge()</mark></h5>
          <div class="my-3">
            selection.merge API 主要是用在selection.join
            API內部，當資料綁定後處理 enter 與 update selection， 並依據 index
            去填補原本是 null 的位置。
            以下範例是將奇數資料與偶數資料合併，並呈現在右方框框內
          </div>
          <div class="d-flex">
            <div
              class="border border-dark left py-2 px-4 w-50 d-flex merge justify-content-between"
            >
              <div class="text-center mergedData">
                <p>原始資料</p>
                <h6>1</h6>
                <h6>2</h6>
                <h6>3</h6>
                <h6>4</h6>
                <h6>5</h6>
              </div>
              <div class="text-center">
                <p>奇數資料</p>
                <h6>1</h6>
                <h6>3</h6>
                <h6>5</h6>
              </div>
              <div class="text-center">
                <p>偶數資料</p>
                <h6>2</h6>
                <h6>4</h6>
                <h6>6</h6>
              </div>
            </div>
            <div
              class="border border-dark right text-center py-2 px-4 w-50 mergedContainer"
            >
              <p>奇數資料與偶數資料合併後</p>
            </div>
          </div>

          <p class="my-4 mb-1 fs-5">程式碼</p>
          <pre class="border">
             <code class="language-html line-numbers remove-initial-line-feed" data-prismjs-copy="複製程式碼">
                //html
                &lt;div class=&quot;text-center mergedData&quot;&gt;
                  &lt;p&gt;原始資料&lt;/p&gt;
                  &lt;h6&gt;1&lt;/h6&gt;
                  &lt;h6&gt;2&lt;/h6&gt;
                  &lt;h6&gt;3&lt;/h6&gt;
                  &lt;h6&gt;4&lt;/h6&gt;
                  &lt;h6&gt;5&lt;/h6&gt;
                &lt;/div&gt;

                &lt;div class=&quot;border border-dark right text-center py-2 px-4 w-50 mergedContainer&quot;&gt;
                  &lt;p&gt;奇數資料與偶數資料合併後
                  &lt;/p&gt;
                &lt;/div&gt;
             </code>
            </pre>
          <pre>
              <code class="language-js line-numbers remove-initial-line-feed">
                //JS
                const even = d3.select('.mergedData').selectAll("h6")
                                .select(function (d, i) {
                                    return i & 1 ? this : null
                                  });

                const odd = d3.select('.mergedData').selectAll("h6")
                              .select(function (d, i) {
                                  return i & 1 ? null : this
                              });
                    
                const merged = odd.merge(even);
                const mergedContainer = d3.select('.mergedContainer')
                for(const element of merged._groups[0]){
                  mergedContainer.append('p').text(element.innerText)
                }
              </code>
            </pre>
        </div>

        <!-- 範例圖表 -->
        <div class="mt-5">
          <h4>範例圖表</h4>
          <div class="my-3">
            <label for="">資料數量</label>
            <input type="number" class="dataLength me-3" />
            <button type="button" class="btn getRandomData btn-primary">
              點擊產生隨機資料
            </button>
          </div>
          <div class="my-3">data：<span class="showData"></span></div>

          <div class="chartWrap"></div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script src="./extension/prism.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      //bind data single
      const bindData = d3
        .select(".bindData")
        .data(["綁定資料"])
        .text((d) => d);

      console.log("bindData", bindData);
      console.log(bindData["_groups"][0][0]["__data__"]);

      // bind data multiple
      const multiData = ["綁", "定", "資", "料"];
      const bindMultiData = d3
        .selectAll(".bindMultiData")
        .data(multiData)
        .text((d) => d);

      console.log("bindMultiData", bindMultiData);

      //bind Unmatch Data
      const UnmatchData = ["綁", "定", "資", "料"];
      const bindUnmatchData = d3
        .selectAll(".bindUnmatchData")
        .data(UnmatchData)
        .text((d) => d);

      console.log("bindUnmatchData", bindUnmatchData);

      //datum
      const datumObj = [{ name: "jin" }, { name: "JIN" }];
      const bindDatum = d3.select(".datum").datum(datumObj);
      console.log("bindDatum", bindDatum);

      // enter data
      const enterData = ["資", "料", "比", "較", "多"];
      const enterDom = d3
        .select(".enterData")
        .selectAll("p")
        .data(enterData)
        .text((d) => d);

      console.log("enterDom", enterDom);

      enterDom
        .enter()
        .append("p")
        .text((d) => d)
        .classed("fw-bold", true)
        .classed("text-danger", true);

      // exit data
      const exitData = ["資", "料", "少"];
      const exitDom = d3
        .select(".exitData")
        .selectAll("p")
        .data(exitData)
        .text((d) => d);

      console.log("exitDom", exitDom);

      exitDom.exit().remove();

      // join data
      const joinData = ["j", "o", "i", "n"];
      d3.select(".joinData")
        .selectAll("p")
        .data(joinData)
        .join() // 把 update 跟 enter 一起處理
        .append("p")
        .attr("class", "text-danger")
        .text((d) => d);

      // selection.merge
      const even = d3
        .select(".mergedData")
        .selectAll("h6")
        .select(function (d, i) {
          return i & 1 ? this : null;
        });

      const odd = d3
        .select(".mergedData")
        .selectAll("h6")
        .select(function (d, i) {
          return i & 1 ? null : this;
        });

      const merged = odd.merge(even);
      const mergedContainer = d3.select(".mergedContainer");
      for (const element of merged._groups[0]) {
        mergedContainer.append("p").text(element.innerText);
      }

      // 範例圖表
      const getRandomData = document.querySelector(".getRandomData");
      const dataLength = document.querySelector("input");
      const showData = document.querySelector(".showData");
      let randomData = [];

      // 增加陣列
      getRandomData.addEventListener("click", (e) => {
        randomData.length = 0;
        for (i = 0; i < dataLength.value; i++) {
          // 產生並塞入隨機亂數資料
          let random = Math.floor(Math.random() * 5);
          randomData.push(random);
        }

        showData.innerHTML = randomData;

        // 繪製圖表
        drawDiagram();
      });

      // 建立 svg 畫布
      const rangeSelect = d3
        .select(".chartWrap")
        .append("svg")
        .attr("width", 500)
        .attr("height", 400)
        .style("border", "1px solid rgb(96, 96, 96)");

      // 製作圖表
      const drawDiagram = () => {
        // 綁定 update 資料
        let rects = rangeSelect.selectAll("rect").data(randomData);

        // update 更新綁定的資料
        rects.attr("width", (d) => d * 60);

        // 用 enter 加上少的DOM元素
        rects
          .enter()
          .append("rect")
          .attr("width", (d) => d * 60)
          .attr("height", 40)
          .style("fill", "blue")
          .attr("x", (d, index) => 0) // 設定y位置
          .attr("y", (d, index) => index * 60); // 設定x軸位置

        // 用 exit 移除多的 DOM 元素
        rects.exit().remove();
      };
    </script>
  </body>
</html>
